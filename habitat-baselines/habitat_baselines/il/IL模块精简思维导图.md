# IL模块核心训练流程思维导图

## 🎯 总体架构

```
EmbodiedQA系统
├── 阶段1: 特征学习 (MultitaskCNN)
├── 阶段2: 任务训练 (VQA + PACMAN)
└── 阶段3: 端到端微调
```

---

## 📊 三大核心模型

### 🔧 模型1: MultitaskCNN

**目标**: 学习通用视觉表示

```
输入: RGB图像 (3,H,W)
├── 编码器: ResNet-based
│   └── 输出: 512维特征
├── 解码器: 反卷积层
└── 多任务头:
    ├── RGB重建
    ├── 深度估计
    └── 语义分割
```

**训练配置**:
- 损失: SmoothL1 + CrossEntropy
- 优化器: Adam (lr=1e-4)
- 训练: 20-30 epochs

### 🤖 模型2: VQA模型

**目标**: 图像序列问答

```
输入: 图像序列 + 问题文本
├── 图像分支:
│   ├── CNN特征提取 (预训练)
│   └── LSTM编码 (512维)
├── 问题分支:
│   ├── 词嵌入 (300维)
│   └── LSTM编码 (512维)
├── 注意力机制:
│   ├── 图像注意力
│   └── 问题注意力
└── 分类器: 答案概率分布
```

**训练配置**:
- 损失: CrossEntropyLoss
- 优化器: Adam (lr=5e-5)
- 评估: 准确率 + 平均排名

### 🧭 模型3: PACMAN导航

**目标**: 分层导航控制

```
输入: 多模态特征 (图像+问题+动作+目标)
├── 特征融合: 640维向量
├── 规划器 (Planner):
│   ├── NavRnn (LSTM)
│   └── 高级动作决策
├── 控制器 (Controller):
│   ├── NavRnn (GRU)
│   └── 低级控制信号
└── 解码器: 动作概率分布
```

**训练配置**:
- 损失: MaskedNLLCriterion
- 策略: 模仿学习 (行为克隆)
- 评估: 成功率 + SPL

---

## 🔄 训练流程

### 阶段1: 预训练 (20-30 epochs)
```
MultitaskCNN预训练
├── 数据: RGB + 深度 + 语义标签
├── 目标: 学习视觉表示
└── 输出: 预训练特征提取器
```

### 阶段2: 独立训练 (30-50 epochs)
```
并行训练
├── VQA模型:
│   ├── 加载: 预训练CNN特征
│   ├── 训练: LSTM + 注意力
│   └── 数据: 问答对
└── PACMAN模型:
    ├── 加载: 预训练CNN特征
    ├── 训练: 分层导航网络
    └── 数据: 导航轨迹
```

### 阶段3: 联合微调 (10-20 epochs)
```
端到端训练
├── 加载: 所有预训练模型
├── 微调: 小学习率联合优化
├── 数据: 完整EQA任务
└── 评估: 导航成功率 + 问答准确率
```

---

## 📋 关键技术点

### 🏗️ 网络架构
```
MultitaskCNN:
├── 编码器: ResNet + 跳跃连接
├── 瓶颈: 512维特征向量
└── 解码器: 反卷积 + 多任务头

VQA模型:
├── 双分支: 图像LSTM + 问题LSTM
├── 注意力: 多模态交互
└── 融合: 特征拼接 + MLP

PACMAN:
├── 分层: 规划器 + 控制器
├── NavRnn: LSTM/GRU可选
└── 解码: 联合动作预测
```

### ⚙️ 训练策略
```
优化技巧:
├── 分阶段训练: 避免端到端不稳定
├── 预训练策略: 利用多任务学习
├── 模仿学习: 专家演示监督
├── 注意力机制: 多模态特征对齐
└── 分层架构: 高级规划 + 低级控制
```

### 📊 数据处理
```
数据要求:
├── MatterPort3D: 3D场景数据
├── EQA数据集: 问答 + 导航轨迹
├── 预处理: 图像标准化 + 文本tokenization
└── 增强: 随机变换 + 序列扰动
```

---

## 🎯 核心配置

### 超参数设置
```
模型参数:
├── 特征维度: 512
├── LSTM隐藏层: 512
├── 注意力维度: 256
├── 词嵌入维度: 300
└── 序列长度: 图像20帧, 文本15词

训练参数:
├── Batch Size: 16-32
├── 学习率: 1e-4 → 5e-5 → 1e-5
├── 权重衰减: 1e-5
├── Dropout: 0.3-0.5
└── 梯度裁剪: max_norm=1.0-5.0
```

### 评估指标
```
VQA评估:
├── Top-1准确率
├── Top-5准确率
├── 平均排名 (MR)
└── 平均倒数排名 (MRR)

导航评估:
├── 成功率 (Success Rate)
├── SPL (路径效率)
├── 平均步数
└── 导航精度
```

---

## 🚀 实际应用

### 训练命令
```bash
# 阶段1: CNN预训练
python run.py --config-name=il_eqa_cnn_pretrain.yaml

# 阶段2a: VQA训练
python run.py --config-name=il_vqa.yaml

# 阶段2b: 导航训练
python run.py --config-name=il_pacman.yaml

# 阶段3: 端到端微调
python run.py --config-name=il_eqa_end_to_end.yaml
```

### 模型文件
```
检查点:
├── multitask_cnn_pretrained.pth
├── vqa_model_pretrained.pth
├── pacman_model_pretrained.pth
└── eqa_final_model.pth
```

---

## 💡 关键优势

- ✅ **分阶段训练**: 稳定性好，收敛快
- ✅ **多任务学习**: 特征质量高
- ✅ **注意力机制**: 多模态对齐
- ✅ **分层架构**: 复杂任务分解
- ✅ **模仿学习**: 利用专家知识
- ✅ **端到端优化**: 整体性能提升

---

## 📈 性能指标

```
预期性能:
├── VQA准确率: >60%
├── 导航成功率: >70%
├── SPL: >0.5
└── 训练时间: 3-5天 (单GPU)
```

这个精简思维导图提供了IL模块的核心要点，便于快速理解和实施！